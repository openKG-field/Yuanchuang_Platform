<template>
  <div class="template-wrapper">
    <header>
      <!-- Âà†Èô§AI‰ª£ÁêÜÁöÑÊ†áÈ¢ò -->
    </header>
    <main class="main-content">
      <aside :class="['sidebar', { collapsed: taskListCollapsed }]">
        <div class="task-list">
          <div class="toggle-icon">
            <el-icon @click="toggleTaskList">
              <component :is="taskListCollapsed ? 'el-icon-arrow-right' : 'el-icon-arrow-left'" />
            </el-icon>
          </div>
          <h2 v-if="!taskListCollapsed">‰ªªÂä°ËÆ∞ÂΩï</h2>
          <div v-if="!taskListCollapsed" class="task-counter">
            <p>ÊÄª‰ªªÂä°Êï∞: <span class="count">{{ totalTaskCount }}</span></p>
          </div>
          <ul v-if="!taskListCollapsed" class="task-history">
            <li
              v-for="(task, index) in recentTasks"
              :key="index"
              class="task-item parent-task"
              :class="{ 'active': selectedParentTask === task }"
            >
              <div class="parent-row" @click="selectParentTask(task)">
                <el-icon class="expand-icon" @click.stop="toggleParentExpand(task)">
                  <component :is="isParentExpanded(task) ? 'el-icon-arrow-up' : 'el-icon-arrow-down'" />
                </el-icon>
                <span class="task-name h1">{{ task }}</span>
                <span class="delete-icon" @click.stop="deleteParentTask(task)">üóëÔ∏è</span>
              </div>
              <!-- ‰∫åÁ∫ßÊ†áÈ¢òÔºàÂ≠ê‰ªªÂä°Ôºâ -->
              <div v-if="isParentExpanded(task)" class="subtasks-list">
                <div class="sub-task-header">Â≠ê‰ªªÂä°</div>
                <button
                  v-for="pt in (selectedParentTask === task ? planTasks : [])"
                  :key="pt.id"
                  class="dynamic-task-button h2"
                  :class="{ active: activePlanTaskId === pt.id }"
                  @click.stop="selectPlanTask(pt)"
                >
                  <span class="task-text">{{ pt.name }}</span>
                </button>
              </div>
            </li>
          </ul>
        </div>
        <!-- Âè™‰øùÁïôÊ∑ªÂä†‰ªªÂä°ÊåâÈíÆ -->
        <div class="left-bottom-add">
          <button @click.stop="addTask">Ê∑ªÂä†‰ªªÂä°</button>
        </div>
      </aside>
      <section class="template-container">
        <!-- ÂèØÊäòÂè†ÁöÑ AI ÂõûÂ§çÊùøÂùó -->
        <div ref="aiPanel" class="ai-response">
          <h2>Â≠ê‰ªªÂä°ÂÜÖÂÆπ</h2>
          <div v-show="aiPanelExpanded" class="ai-content">
            <!-- ÁºñËæë/ÊµèËßàÊ®°ÂºèÂàáÊç¢ -->
            <div v-if="activePlanTaskId">
              <div v-if="!isEditingPlan">
                <VueMarkdownIt v-if="currentPlanContent" class="ai-text" :source="currentPlanContent" />
                <div style="margin-top:12px; display:flex; gap:8px;">
                  <button class="continue-button" @click.stop="() => { isEditingPlan = true; editablePlanContent = currentPlanContent; }">ÁºñËæë</button>
                  <button class="continue-button" @click.stop="showPlanVersions">ÂéÜÂè≤</button>
                </div>
              </div>
              <div v-else>
                <textarea v-model="editablePlanContent" style="width:100%;min-height:200px;" />
                <div style="margin-top:12px; display:flex; gap:8px;">
                  <button class="continue-button" @click.stop="() => saveCurrentPlanContent('Áî®Êà∑ÁºñËæë')">‰øùÂ≠ò</button>
                  <button class="continue-button" @click.stop="() => { isEditingPlan = false; editablePlanContent = currentPlanContent; }">ÂèñÊ∂à</button>
                </div>
              </div>
            </div>
            <!-- Êó†ÈÄâ‰∏≠Â≠ê‰ªªÂä°Êó∂‰∏çÂÜçÊòæÁ§∫ Final AI Response ÂÖúÂ∫ïÂÜÖÂÆπ -->
          </div>
        </div>

  <div ref="tasks" class="tasks">
          <h2>Â∑≤Ê∑ªÂä†‰ªªÂä°</h2>
          <ul v-show="tasksPanelExpanded">
            <!-- Êñ∞Â¢ûÔºöÂ±ïÁ§∫‰∏â‰∏™Â≠ê‰ªªÂä°ÁöÑÁÆÄË¶ÅÂàóË°® -->
            <li v-for="pt in planTasks" :key="pt.id">{{ pt.name }}</li>
          </ul>
        </div>
        
        <footer class="right-footer">
          <button class="continue-button" @click="handleContinue">ÁªßÁª≠</button>
        </footer>
      </section>
    </main>
  </div>
</template>

<script>
import { ElIcon } from 'element-plus';
import { ArrowRight, ArrowLeft, ArrowDown, ArrowUp } from '@element-plus/icons-vue';
import VueMarkdownIt from 'vue3-markdown-it';

export default {
  name: 'TaskManager',
  components: {
    ElIcon,
    'el-icon-arrow-right': ArrowRight,
    'el-icon-arrow-left': ArrowLeft,
  'el-icon-arrow-down': ArrowDown,
  'el-icon-arrow-up': ArrowUp,
    VueMarkdownIt
  },
  data() {
    return {
      taskDetails: {
        area: this.$route.query.area || '',
        audience: this.$route.query.audience || '',
        keywords: this.$route.query.keywords || '',
        tone: this.$route.query.tone || '',
        prompt: this.$route.query.prompt || ''
      },
      selectedTask: 'taskid1',
      taskListCollapsed: false,
  expandedParents: {}, // ËÆ∞ÂΩïÊØè‰∏™Áà∂‰ªªÂä°ÊòØÂê¶Â±ïÂºÄ { '‰ªªÂä°1': true/false }
      taskid2Visible: false,
      currentTime: new Date().toLocaleString(),
      tasksPanelExpanded: true, // ÊéßÂà∂Â∑≤Ê∑ªÂä†‰ªªÂä°ÊùøÂùóÂ±ïÂºÄ/Êî∂Ëµ∑
      aiPanelExpanded: true, // ÊéßÂà∂AIÂõûÂ§çÊùøÂùóÂ±ïÂºÄ/Êî∂Ëµ∑
      totalTaskCount: 0, // Dialog.vue‰∏≠ÁöÑÊÄª‰ªªÂä°Êï∞
      recentTasks: [], // ÊúÄËøëÁöÑ‰ªªÂä°ÂàóË°®
  addedTasks: ['taskid1'], // Â∑≤Ê∑ªÂä†ÁöÑ‰ªªÂä°ÂàóË°®Ôºà‰øùÁïôÂéüÊúâÔºâ
      taskManagerId: null, // Êï∞ÊçÆÂ∫ì‰∏≠ÁöÑËÆ∞ÂΩïID
      currentTaskName: '', // ÂΩìÂâç‰ªªÂä°ÂêçÁß∞
      subTasksMap: {}, // Â≠òÂÇ®ÊØè‰∏™Áà∂‰ªªÂä°ÂØπÂ∫îÁöÑÂ≠ê‰ªªÂä°ÂàóË°® { '‰ªªÂä°1': ['‰ªªÂä°1.1', '‰ªªÂä°1.2'], '‰ªªÂä°2': [...] }
      selectedParentTask: null, // ÂΩìÂâçÈÄâ‰∏≠ÁöÑÁà∂‰ªªÂä°
  baseTaskNumber: 1, // Âü∫Á°Ä‰ªªÂä°ÁºñÂè∑
  // Êñ∞Â¢ûÔºö‰∏âÁ±ªÂ≠ê‰ªªÂä°‰∏éÂÜÖÂÆπ
  taskPlan: null,
  planTasks: [], // [{id,name,content}]
  activePlanTaskId: null,
  // ÁºñËæëÊÄÅ
  isEditingPlan: false,
  editablePlanContent: ''
    };
  },
  computed: {
    // ÁßªÈô§‰∫ÜÂéüÊù•ÁöÑ task1Markdown Âíå task2Markdown ËÆ°ÁÆóÂ±ûÊÄß
    // Áé∞Âú®‰ΩøÁî® generateTaskMarkdown ÊñπÊ≥ïÂä®ÊÄÅÁîüÊàê
    currentPlanContent() {
      if (!this.planTasks || !this.activePlanTaskId) return '';
      const found = this.planTasks.find(t => t.id === this.activePlanTaskId);
      return found?.content || '';
    }
  },
  mounted() {
    // Âä†ËΩΩDialog.vueÁöÑ‰ªªÂä°Êï∞ÊçÆ
    this.loadDialogTasks();
    
    // ‰ºòÂÖà‰ªéË∑ØÁî±ÂèÇÊï∞Ëé∑ÂèñÂΩìÂâç‰ªªÂä°ÂêçÁß∞
    let taskName = this.$route.query.currentTask;
    
    // Â¶ÇÊûúË∑ØÁî±Ê≤°Êúâ‰º†ÈÄí‰ªªÂä°ÂêçÁß∞Ôºå‰ΩøÁî®ÈªòËÆ§ÈÄªËæë
    if (!taskName) {
      taskName = this.getCurrentTaskName();
    }
    
    this.currentTaskName = taskName;
    
    // ËÆæÁΩÆÈÄâ‰∏≠ÁöÑÁà∂‰ªªÂä°ÔºàÁ°Æ‰øù‰∏éÂΩìÂâç‰ªªÂä°‰∏ÄËá¥Ôºâ
    if (taskName && this.recentTasks.includes(taskName)) {
      this.selectedParentTask = taskName;
    } else if (this.recentTasks.length > 0) {
      // Â¶ÇÊûú‰º†ÈÄíÁöÑ‰ªªÂä°ÂêçÁß∞‰∏çÂú®‰ªªÂä°ÂàóË°®‰∏≠ÔºåÂàôÈÄâÊã©Á¨¨‰∏Ä‰∏™‰ªªÂä°
      this.selectedParentTask = this.recentTasks[0];
      this.currentTaskName = this.recentTasks[0];
    }
    
    console.log(`TaskManagerÂàùÂßãÂåñ - ÂΩìÂâç‰ªªÂä°: ${this.currentTaskName}, ÈÄâ‰∏≠Áà∂‰ªªÂä°: ${this.selectedParentTask}`);
    
    // Âä†ËΩΩÈÄâ‰∏≠‰ªªÂä°ÁöÑÊï∞ÊçÆ
  this.loadTaskData(this.currentTaskName);

  // ‰ºòÂÖà‰ªéÂêéÁ´ØÂä†ËΩΩÊåÅ‰πÖÂåñÁöÑ‰ªªÂä°ËßÑÂàíÔºåÂ§±Ë¥•ÂÜçÂõûÈÄÄsession
  this.loadTaskPlanFromBackend();
  },
  
  // ÁªÑ‰ª∂ÊøÄÊ¥ªÊó∂Ôºà‰ªéÂÖ∂‰ªñË∑ØÁî±ËøîÂõûÊó∂Ôºâ
  activated() {
    console.log('TaskManager activated - reloading data');
    // ÈáçÊñ∞Âä†ËΩΩDialog‰ªªÂä°Êï∞ÊçÆ
    this.loadDialogTasks();
    
    // ‰ºòÂÖà‰ªéË∑ØÁî±ÂèÇÊï∞Ëé∑ÂèñÂΩìÂâç‰ªªÂä°ÂêçÁß∞
    let taskName = this.$route.query.currentTask;
    
    // Â¶ÇÊûúË∑ØÁî±Ê≤°Êúâ‰º†ÈÄí‰ªªÂä°ÂêçÁß∞Ôºå‰ΩøÁî®ÈªòËÆ§ÈÄªËæë
    if (!taskName) {
      taskName = this.getCurrentTaskName();
    }
    
    this.currentTaskName = taskName;
    
    // ËÆæÁΩÆÈÄâ‰∏≠ÁöÑÁà∂‰ªªÂä°ÔºàÁ°Æ‰øù‰∏éÂΩìÂâç‰ªªÂä°‰∏ÄËá¥Ôºâ
    if (taskName && this.recentTasks.includes(taskName)) {
      this.selectedParentTask = taskName;
    }
    
    console.log(`TaskManager activated - ÂΩìÂâç‰ªªÂä°: ${this.currentTaskName}, ÈÄâ‰∏≠Áà∂‰ªªÂä°: ${this.selectedParentTask}`);
    
    // ÈáçÊñ∞Âä†ËΩΩÈÄâ‰∏≠‰ªªÂä°ÁöÑÊï∞ÊçÆ
  this.loadTaskData(taskName);
  // ÈáçÊñ∞ÂêåÊ≠•‰ªªÂä°ËßÑÂàíÔºàÂêéÁ´Ø‰ºòÂÖàÔºâ
  this.loadTaskPlanFromBackend();
  },
  
  beforeUnmount() {
    // Âú®ÁªÑ‰ª∂Âç∏ËΩΩÂâçÁ°Æ‰øùÊï∞ÊçÆÂ∑≤‰øùÂ≠ò
    if (this.taskManagerId) {
      this.updateDatabase();
    }
  },
  methods: {
    // Áà∂‰ªªÂä°ÊòØÂê¶Â±ïÂºÄ
    isParentExpanded(taskName) {
      return !!this.expandedParents[taskName];
    },
    // ÂàáÊç¢Áà∂‰ªªÂä°Â±ïÂºÄ/Êî∂Ëµ∑
    toggleParentExpand(taskName) {
      this.$set ? this.$set(this.expandedParents, taskName, !this.expandedParents[taskName])
                : (this.expandedParents = { ...this.expandedParents, [taskName]: !this.expandedParents[taskName] });
    },
    // ‰ªéËÆ°ÂàíÂÜÖÂÆπ‰∏≠ÊèêÁÇºË¶ÅÁÇπÔºå‰æõ‰∏ã‰∏ÄÊ≠•È°µÈù¢ÊâìÂãæÈÄâÊã©
    buildIssuesFromPlan() {
      const issues = [];
      const pushClean = (line) => {
        if (!line) return;
        const cleaned = String(line)
          .replace(/^\s*[#>*\-‚Ä¢\d\)\.]\s*/, '')
          .replace(/[`*_>~]/g, '')
          .trim();
        if (cleaned && !issues.includes(cleaned)) issues.push(cleaned);
      };
      (this.planTasks || []).forEach(t => {
        const content = (t && t.content) ? String(t.content) : '';
        if (content) {
          const lines = content.split(/\r?\n/).filter(Boolean);
          for (const ln of lines) {
            if (/^\s*([#>*\-‚Ä¢]|\d+\.|\d+\))/.test(ln)) pushClean(ln);
            if (issues.length >= 12) break;
          }
        }
        if (issues.length < 3) pushClean(t?.name);
      });
      // È¢ùÂ§ñÂÖúÂ∫ïÔºö‰ªéË°®ÂçïËØ¶ÊÉÖ‰∏≠ÊãÜËØç
      if (issues.length === 0) {
        const extra = [this.taskDetails?.keywords, this.taskDetails?.prompt, this.taskDetails?.area]
          .filter(Boolean)
          .join('\n')
          .split(/[Ôºå,;Ôºõ\n]/)
          .map(s => s.trim())
          .filter(Boolean);
        extra.slice(0, 8).forEach(pushClean);
      }
      return issues.slice(0, 12);
    },
    // ÊÅ¢Â§ç‚ÄúÁªßÁª≠‚ÄùÊåâÈíÆÈÄªËæëÔºö‰∏ç‰æùËµñ AIÔºåÁõ¥Êé•ÊääË¶ÅÁÇπ‰º†Áªô NewIntegration
    handleContinue() {
      const issues = this.buildIssuesFromPlan();
      const payload = (issues.length ? issues : ['ËØ∑ÂÖàÂÆåÂñÑ‰ªªÂä°Ë¶ÅÁÇπ']).join('\n');
      // Â∞ÜÂΩìÂâç‰ªªÂä°Âêç‰∏ÄÂπ∂‰º†ÈÄíÔºå‰æø‰∫é NewIntegration Êåâ‰ªªÂä°Âä†ËΩΩÂØπÂ∫îÁöÑ‰∏â‰∏™Â≠ê‰ªªÂä°
      const currentTask = this.getCurrentTaskName();
      this.$router.push({
        name: 'NewIntegration',
        query: { issues: payload, currentTask }
      });
    },
    // Áªü‰∏Ä fetchÔºåËã• Vite ‰ª£ÁêÜÂ§±Ë¥•Ôºà404 ÊàñËøîÂõû HTMLÔºâÔºåÂõûÈÄÄÁõ¥ËøûÂêéÁ´Ø
    async safeFetch(input, init) {
      const res = await fetch(input, init);
      const needFallback = res.status === 404 || ((res.headers.get('content-type') || '').includes('text/html'));
      if (!needFallback) return res;
      try {
        const url = typeof input === 'string' ? input : input.url;
        if (url?.startsWith('/api/')) {
          const fallbackUrl = `http://localhost:3000${url}`;
          return await fetch(fallbackUrl, init);
        }
      } catch (_) {}
      return res;
    },
    showPlanVersions: async function() {
      const v = await this.loadPlanVersions();
      console.log('ÁâàÊú¨ÂéÜÂè≤', v);
      window.alert(`ÁâàÊú¨Êï∞Ôºö${v.length}`);
    },
    async loadTaskPlanFromBackend() {
      try {
        const taskName = this.getCurrentTaskName();
        const resp = await this.safeFetch(`/api/task-plan/${encodeURIComponent(taskName)}`);
        if (resp.ok) {
          const ct = resp.headers.get('content-type') || '';
          if (!ct.includes('application/json')) {
            throw new Error(`ÈùûJSONÂìçÂ∫î: ${ct}`);
          }
          const data = await resp.json();
          if (Array.isArray(data.tasks) && data.tasks.length) {
            this.taskPlan = { tasks: data.tasks };
            this.planTasks = data.tasks;
            this.activePlanTaskId = this.planTasks[0]?.id || null;
            // ÁªëÂÆöÂêå‰∏ÄÊù°ËÆ∞ÂΩïÁöÑIDÔºå‰øùËØÅÂêéÁª≠ update ÂëΩ‰∏≠Âêå‰∏ÄË°å
            if (data.id) {
              this.taskManagerId = data.id;
              // ÁºìÂ≠òÊò†Â∞ÑÔºö‰ªªÂä°Âêç -> Ë°åID
              try {
                const map = JSON.parse(localStorage.getItem('tmIdMap') || '{}');
                map[taskName] = data.id;
                localStorage.setItem('tmIdMap', JSON.stringify(map));
              } catch (_) {}
            }
            if (this.selectedParentTask) {
              this.subTasksMap[this.selectedParentTask] = this.planTasks.map(t => t.name);
            }
            return;
          }
        }
        // ÂõûÈÄÄÂà∞‰ºöËØù
        this.loadTaskPlanFromSession();
      } catch (e) {
        console.warn('ÂêéÁ´ØÂä†ËΩΩ‰ªªÂä°ËßÑÂàíÂ§±Ë¥•ÔºåÂõûÈÄÄ‰ºöËØù:', e.message);
        this.loadTaskPlanFromSession();
      }
    },
    // ËØªÂèñ sessionStorage ‰∏≠ÁöÑ‰ªªÂä°ËßÑÂàí
    loadTaskPlanFromSession() {
      try {
        const raw = sessionStorage.getItem('taskPlan');
        if (!raw) return;
        const plan = JSON.parse(raw);
        if (!Array.isArray(plan.tasks)) return;
        this.taskPlan = plan;
        this.planTasks = plan.tasks;
        // ÈªòËÆ§ÈÄâ‰∏≠Á¨¨‰∏ÄÈ°π
        this.activePlanTaskId = this.planTasks[0]?.id || null;
        // Â∞Ü plan Â≠ê‰ªªÂä°ÊåÇÊé•Âà∞ÂΩìÂâçÁà∂‰ªªÂä°‰∏ã‰ª•‰æøÂ∑¶‰æßÊ∏≤ÊüìÔºà‰∏çÂΩ±ÂìçÂéüÊúârecentTasksÊòæÁ§∫ÈÄªËæëÔºâ
        if (this.selectedParentTask) {
          this.subTasksMap[this.selectedParentTask] = this.planTasks.map(t => t.name);
        }
        // Ëã•‰ªÖÊúâÊú¨Âú∞‰ºöËØùÊï∞ÊçÆÔºåÂ∞ùËØïÊü•ËØ¢ÂêéÁ´Ø‰ª•Ëé∑ÂèñËØ•‰ªªÂä°ÁöÑËÆ∞ÂΩïIDÔºå‰æø‰∫éÂêéÁª≠ update
        const taskName = this.getCurrentTaskName();
        this.safeFetch(`/api/task-manager-content/${encodeURIComponent(taskName)}`)
          .then(r => r.ok ? r.json() : null)
          .then(data => {
            const tm = data && data.taskManagerContents && data.taskManagerContents[0];
            if (tm && tm.id) {
              this.taskManagerId = tm.id;
              try {
                const map = JSON.parse(localStorage.getItem('tmIdMap') || '{}');
                map[taskName] = tm.id;
                localStorage.setItem('tmIdMap', JSON.stringify(map));
              } catch (_) {}
            }
          })
          .catch(() => {});
        console.log('Â∑≤Âä†ËΩΩ‰ªªÂä°ËßÑÂàí:', this.planTasks.map(t => t.name));
      } catch (e) {
        console.warn('Ëß£Êûê‰ªªÂä°ËßÑÂàíÂ§±Ë¥•:', e);
      }
    },
    // ‰øùÂ≠òÂΩìÂâçÈÄâ‰∏≠Â≠ê‰ªªÂä°ÁöÑ MarkdownÔºàÂÜôÁâàÊú¨Ôºâ
  async saveCurrentPlanContent(note = '') {
    if (!this.activePlanTaskId) return;
    const content = this.editablePlanContent ?? this.currentPlanContent;
    const taskName = this.getCurrentTaskName();
    const currentTask = (this.planTasks || []).find(t => String(t.id) === String(this.activePlanTaskId));
    const subTaskName = currentTask?.name || null;
      try {
        // È¶ñÊ¨°Â∞ùËØïÁõ¥Êé•ÁºñËæë
        let resp = await this.safeFetch(`/api/task-plan/${encodeURIComponent(taskName)}/edit`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ subTaskId: this.activePlanTaskId, subTaskName, content, note })
        });
        let ct = resp.headers.get('content-type') || '';
        let data = ct.includes('application/json') ? await resp.json() : null;
        if (!resp.ok || !data?.success) {
          console.warn('‰øùÂ≠òÂ≠ê‰ªªÂä°Â§±Ë¥•ÔºåÂ∞ùËØïÂõûÈÄÄ‰∏äÈÄÅËÆ°ÂàíÂÜçÈáçËØï:', data?.message || resp.status);
          // Âú®ÂõûÈÄÄ‰øùÂ≠òÂâçÔºåÂÖàÊãâÂèñÂêéÁ´ØÁé∞ÊúâÂÖ®ÈÉ® tasks Âπ∂‰∏éÂΩìÂâçÁºñËæëÂÜÖÂÆπËøõË°åÂêàÂπ∂ÔºåÈÅøÂÖçÂè™‰øùÂ≠òÂçïÈ°πË¶ÜÁõñ
          let allTasks = Array.isArray(this.planTasks) ? JSON.parse(JSON.stringify(this.planTasks)) : [];
          try {
            const getResp = await this.safeFetch(`/api/task-plan/${encodeURIComponent(taskName)}`);
            if (getResp.ok) {
              const getCt = getResp.headers.get('content-type') || '';
              if (getCt.includes('application/json')) {
                const getData = await getResp.json();
                if (Array.isArray(getData.tasks) && getData.tasks.length) {
                  allTasks = getData.tasks;
                }
              }
            }
          } catch(_) {}
          // ÂêàÂπ∂ÂΩìÂâçÂ≠ê‰ªªÂä°ÂÜÖÂÆπÂà∞ allTasks
          const idx2 = allTasks.findIndex(t => String(t.id) === String(this.activePlanTaskId) || t.name === subTaskName);
          if (idx2 >= 0) {
            allTasks[idx2] = { ...allTasks[idx2], content };
          } else {
            allTasks.push({ id: this.activePlanTaskId, name: subTaskName || String(this.activePlanTaskId), content });
          }
          // ÂÖà upsert ÂÆåÊï¥ËÆ°Âàí
          const saveResp = await this.safeFetch('/api/task-plan/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ taskName, planTasks: allTasks })
          });
          const saveCt = saveResp.headers.get('content-type') || '';
          if (saveResp.ok && saveCt.includes('application/json')) {
            // ÂÜçÊ¨°Â∞ùËØïÁºñËæë
            resp = await this.safeFetch(`/api/task-plan/${encodeURIComponent(taskName)}/edit`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ subTaskId: this.activePlanTaskId, subTaskName, content, note })
            });
            ct = resp.headers.get('content-type') || '';
            data = ct.includes('application/json') ? await resp.json() : null;
          }
        }
        if (!resp.ok || !data?.success) {
          console.warn('‰øùÂ≠òÂ≠ê‰ªªÂä°Â§±Ë¥•:', data?.message || resp.status);
          return;
        }
        // Êõ¥Êñ∞Êú¨Âú∞ÂÜÖÂÆπ
        const idx = this.planTasks.findIndex(t => t.id === this.activePlanTaskId);
        if (idx !== -1) this.planTasks[idx].content = content;
        this.isEditingPlan = false;
        console.log('Â≠ê‰ªªÂä°Â∑≤‰øùÂ≠ò, ÁâàÊú¨Êï∞:', data.versions?.length || 0);
      } catch (e) {
        console.error('‰øùÂ≠òÂ≠ê‰ªªÂä°ÂºÇÂ∏∏:', e);
      }
    },
    // Ëé∑ÂèñÁâàÊú¨ÂéÜÂè≤
    async loadPlanVersions() {
      if (!this.activePlanTaskId) return [];
      const taskName = this.getCurrentTaskName();
      try {
        const resp = await this.safeFetch(`/api/task-plan/${encodeURIComponent(taskName)}/versions?subTaskId=${encodeURIComponent(this.activePlanTaskId)}`);
        if (resp.ok) {
          const ct = resp.headers.get('content-type') || '';
          if (!ct.includes('application/json')) {
            throw new Error(`ÈùûJSONÂìçÂ∫î: ${ct}`);
          }
          const data = await resp.json();
          return data.versions || [];
        }
      } catch (e) {
        console.warn('Âä†ËΩΩÁâàÊú¨ÂéÜÂè≤Â§±Ë¥•:', e);
      }
      return [];
    },
    // ÈÄâÊã©Â≠ê‰ªªÂä°ÔºàÊù•Ëá™ planÔºâ
    selectPlanTask(task) {
      this.activePlanTaskId = task.id;
      this.selectedTask = task.name;
    },
    addTask() {
      // ÂøÖÈ°ªÂÖàÈÄâ‰∏≠‰∏Ä‰∏™Áà∂‰ªªÂä°
      if (!this.selectedParentTask) {
        console.log('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™Áà∂‰ªªÂä°');
        return;
      }
      
      // Ëé∑ÂèñÂΩìÂâçÁà∂‰ªªÂä°ÁöÑÂ≠ê‰ªªÂä°ÂàóË°®
      const currentSubTasks = this.subTasksMap[this.selectedParentTask] || [];
      
      // ÈôêÂà∂ÊØè‰∏™Áà∂‰ªªÂä°ÊúÄÂ§öÊ∑ªÂä†9‰∏™Â≠ê‰ªªÂä°
      if (currentSubTasks.length >= 9) {
        console.log(`${this.selectedParentTask} Â∑≤ËææÂà∞ÊúÄÂ§ßÂ≠ê‰ªªÂä°Êï∞ÈáèÈôêÂà∂Ôºà9‰∏™Ôºâ`);
        return;
      }
      
      // ÊèêÂèñÁà∂‰ªªÂä°ÁºñÂè∑
      const parentMatch = this.selectedParentTask.match(/‰ªªÂä°(\d+)/);
      if (!parentMatch) {
        console.log('Êó†ÊïàÁöÑÁà∂‰ªªÂä°Ê†ºÂºè');
        return;
      }
      
      const parentNumber = parseInt(parentMatch[1]);
      // ËÆ°ÁÆóÊñ∞Â≠ê‰ªªÂä°ÁºñÂè∑ÔºöÁà∂‰ªªÂä°ÁºñÂè∑ + (ÂΩìÂâçÂ≠ê‰ªªÂä°Êï∞Èáè + 1) * 0.1
      const newTaskNumber = parentNumber + (currentSubTasks.length + 1) * 0.1;
      const newTaskName = `‰ªªÂä°${newTaskNumber.toFixed(1)}`;
      
      // Ê∑ªÂä†Âà∞ÂØπÂ∫îÁà∂‰ªªÂä°ÁöÑÂ≠ê‰ªªÂä°ÂàóË°®
      if (!this.subTasksMap[this.selectedParentTask]) {
        this.subTasksMap[this.selectedParentTask] = [];
      }
      this.subTasksMap[this.selectedParentTask].push(newTaskName);
      
      // ÁªüËÆ°ÂΩìÂâçÂ∑≤Ê∑ªÂä†ÁöÑ‰ªªÂä°Êï∞ÔºàÂè≥‰æßÊòæÁ§∫Áî®Ôºâ
      const nextId = `taskid${this.addedTasks.length + 1}`;
      this.addedTasks.push(nextId);
      this.selectedTask = nextId;
      
      console.log(`‰∏∫ ${this.selectedParentTask} Ê∑ªÂä†Â≠ê‰ªªÂä°: ${newTaskName}`);
      // Êõ¥Êñ∞Êï∞ÊçÆÂ∫ì
      this.updateDatabase();
    },
    async selectParentTask(taskName) {
      this.selectedParentTask = taskName;
      this.selectedTask = taskName;
      console.log(`ÈÄâ‰∏≠Áà∂‰ªªÂä°: ${taskName}`);
      
      // Â¶ÇÊûúËØ•Áà∂‰ªªÂä°ËøòÊ≤°ÊúâÂ≠ê‰ªªÂä°ÂàóË°®ÔºåÂàùÂßãÂåñ‰∏Ä‰∏™Á©∫Êï∞ÁªÑ
      if (!this.subTasksMap[taskName]) {
        this.subTasksMap[taskName] = [];
      }
      
      // ÂàáÊç¢‰ªªÂä°Êó∂ÔºåÈáçÊñ∞Âä†ËΩΩËØ•‰ªªÂä°ÂØπÂ∫îÁöÑAIÂõûÂ§çÂíåÁõ∏ÂÖ≥Êï∞ÊçÆ
      this.currentTaskName = taskName;
      await this.loadTaskData(taskName);
    },
    selectDynamicTask(taskName) {
      this.selectedTask = taskName;
      console.log(`ÈÄâ‰∏≠Â≠ê‰ªªÂä°: ${taskName}`);
    },
    getSubTasks(parentTask) {
      // Ëã•Êúâ‰ªªÂä°ËßÑÂàíÔºå‰ºòÂÖàÊòæÁ§∫ËßÑÂàíÁöÑ‰∏â‰∏™Â≠ê‰ªªÂä°
      if (this.planTasks?.length && parentTask === this.selectedParentTask) {
        return this.planTasks.map(t => t.name);
      }
      return this.subTasksMap[parentTask] || [];
    },
    deleteParentTask(taskName) {
      // ‰ªérecentTasks‰∏≠Âà†Èô§
      const index = this.recentTasks.indexOf(taskName);
      if (index > -1) {
        this.recentTasks.splice(index, 1);
        this.totalTaskCount--;
      }
      
      // Âà†Èô§ÂØπÂ∫îÁöÑÂ≠ê‰ªªÂä°Êò†Â∞Ñ
      delete this.subTasksMap[taskName];
      
      // Â¶ÇÊûúÂà†Èô§ÁöÑÊòØÂΩìÂâçÈÄâ‰∏≠ÁöÑÁà∂‰ªªÂä°ÔºåÊ∏ÖÁ©∫ÈÄâ‰∏≠Áä∂ÊÄÅ
      if (this.selectedParentTask === taskName) {
        this.selectedParentTask = null;
        this.selectedTask = null;
      }
      
      console.log(`Âà†Èô§Áà∂‰ªªÂä°: ${taskName}`);
      
      // Êõ¥Êñ∞localStorage‰∏≠ÁöÑ‰ªªÂä°ÂàóË°®
      this.updateDialogTasks();
      
      // Êõ¥Êñ∞Êï∞ÊçÆÂ∫ì
      this.updateDatabase();
    },
    deleteSubTask(parentTask, subTaskName) {
      if (this.subTasksMap[parentTask]) {
        const index = this.subTasksMap[parentTask].indexOf(subTaskName);
        if (index > -1) {
          this.subTasksMap[parentTask].splice(index, 1);
        }
      }
      
      // Â¶ÇÊûúÂà†Èô§ÁöÑÊòØÂΩìÂâçÈÄâ‰∏≠ÁöÑ‰ªªÂä°ÔºåÊ∏ÖÁ©∫ÈÄâ‰∏≠Áä∂ÊÄÅ
      if (this.selectedTask === subTaskName) {
        this.selectedTask = null;
      }
      
      console.log(`Âà†Èô§Â≠ê‰ªªÂä°: ${subTaskName}`);
      
      // Êõ¥Êñ∞Êï∞ÊçÆÂ∫ì
      this.updateDatabase();
    },
    updateDialogTasks() {
      // Êõ¥Êñ∞localStorage‰∏≠ÁöÑdialogTasks
      try {
        const dialogTasks = JSON.parse(localStorage.getItem('dialogTasks') || '[]');
        // Ê†πÊçÆrecentTasksÊõ¥Êñ∞dialogTasks
        const updatedTasks = dialogTasks.filter(task => this.recentTasks.includes(task));
        localStorage.setItem('dialogTasks', JSON.stringify(updatedTasks));
      } catch (error) {
        console.error('Êõ¥Êñ∞Dialog‰ªªÂä°ÂàóË°®Â§±Ë¥•:', error);
      }
    },
    hoverTask(taskType) {
      if (this.$refs[taskType]) {
        this.$refs[taskType].style.backgroundColor = '#e0ffe0';
      }
    },
    leaveTask(taskType) {
      if (this.$refs[taskType]) {
        this.$refs[taskType].style.backgroundColor = '';
      }
    },
    selectTask(taskType) {
      this.selectedTask = taskType;
    },
    toggleTaskList() {
      this.taskListCollapsed = !this.taskListCollapsed;
    },
    handleTaskClick(taskId) {
      this.selectedTask = taskId;
      if (taskId === 'taskid1') {
        this.currentTime = new Date().toLocaleString();
      }
    },
    toggleTasksPanel() {
      this.tasksPanelExpanded = !this.tasksPanelExpanded;
    },
    toggleAiPanel() {
      this.aiPanelExpanded = !this.aiPanelExpanded;
    },
    
    /**
     * Âä†ËΩΩDialog.vueÁöÑ‰ªªÂä°Êï∞ÊçÆ
     */
    loadDialogTasks() {
      try {
        // ‰ªélocalStorageËé∑ÂèñDialog.vue‰øùÂ≠òÁöÑ‰ªªÂä°Êï∞ÊçÆ
        const dialogTasks = JSON.parse(localStorage.getItem('dialogTasks') || '[]');
        this.totalTaskCount = dialogTasks.length;
        // Âè™ÊòæÁ§∫ÊúÄËøëÁöÑ5‰∏™‰ªªÂä°
        this.recentTasks = dialogTasks.slice(-5).reverse();
        
        // Â¶ÇÊûúÊúâ‰ªªÂä°ÔºåËÆæÁΩÆÂü∫Á°Ä‰ªªÂä°ÁºñÂè∑‰∏∫ÊúÄÊñ∞‰ªªÂä°ÁöÑÁºñÂè∑
        if (dialogTasks.length > 0) {
          // ÊèêÂèñÊúÄÊñ∞‰ªªÂä°ÁöÑÁºñÂè∑ÔºåÂÅáËÆæÊ†ºÂºè‰∏∫"‰ªªÂä°X"
          const latestTask = dialogTasks[dialogTasks.length - 1];
          const match = latestTask.match(/‰ªªÂä°(\d+)/);
          if (match) {
            this.baseTaskNumber = parseInt(match[1]);
          }
        }
      } catch (error) {
        console.error('Âä†ËΩΩ‰ªªÂä°Êï∞ÊçÆÂ§±Ë¥•:', error);
        this.totalTaskCount = 0;
        this.recentTasks = [];
        this.baseTaskNumber = 1;
      }
    },
    
    /**
     * Ëé∑ÂèñÂΩìÂâç‰ªªÂä°ÂêçÁß∞ÔºàÂü∫‰∫éÁî®Êà∑ÈÄâÊã©Ôºâ
     */
    getCurrentTaskName() {
      // ‰ºòÂÖàËøîÂõûÁî®Êà∑ÂΩìÂâçÈÄâÊã©ÁöÑ‰ªªÂä°
      if (this.selectedParentTask) {
        return this.selectedParentTask;
      }
      
      // ÂÖ∂Ê¨°‰ªéË∑ØÁî±ÂèÇÊï∞Ëé∑Âèñ
      if (this.$route.query.currentTask) {
        return this.$route.query.currentTask;
      }
      
      // Â¶ÇÊûúÊ≤°ÊúâÈÄâÊã©‰ªªÂä°ÔºåÂ∞ùËØï‰ªélocalStorageËé∑Âèñ
      try {
        const dialogTasks = JSON.parse(localStorage.getItem('dialogTasks') || '[]');
        const currentTask = localStorage.getItem('currentDialogTask');
        
        if (currentTask && dialogTasks.includes(currentTask)) {
          return currentTask;
        } else if (dialogTasks.length > 0) {
          return dialogTasks[dialogTasks.length - 1];
        } else {
          return 'TaskManager‰ªªÂä°';
        }
      } catch (error) {
        console.error('Ëé∑Âèñ‰ªªÂä°ÂêçÁß∞Â§±Ë¥•:', error);
        return 'TaskManager‰ªªÂä°';
      }
    },
    
    /**
     * ÁîüÊàê‰ªªÂä°ÁöÑMarkdownÂÜÖÂÆπ
     */
    generateTaskMarkdown(taskId, index) {
      const status = index === 0 ? 'ËøõË°å‰∏≠' : 'ÂæÖÂ§ÑÁêÜ';
      const userId = 'Âº†‰∏â'; // ÂèØ‰ª•‰ªéÁî®Êà∑Áä∂ÊÄÅ‰∏≠Ëé∑Âèñ
      const taskNumber = index + 1;
      
      return `**Status:** ${status}  
        **Userid:** ${userId}  
        **Taskid:** ‰ªªÂä°${taskNumber}  
        **startTime:** ${this.currentTime}  
        **taskContent:** ${this.taskDetails.area || 'ÊöÇÊó†ÂÜÖÂÆπ'}`;
            },
    
    /**
     * ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
     */
  async saveToDatabase() {
      try {
        // Ëé∑ÂèñÂΩìÂâçÁúüÊ≠£ÁöÑ‰ªªÂä°ÂêçÁß∞
        const realTaskName = this.getCurrentTaskName();
        
        console.log('TaskManager‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì - ‰ªªÂä°ÂêçÁß∞:', realTaskName);
        
        const response = await fetch('/api/save-task-manager', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            addedTasks: this.addedTasks,
            taskDetails: this.taskDetails,
            taskName: realTaskName
          })
        });

        if (response.ok) {
          const result = await response.json();
          this.taskManagerId = result.id;
          this.currentTaskName = realTaskName; // Êõ¥Êñ∞ÂΩìÂâç‰ªªÂä°ÂêçÁß∞
          console.log('TaskManagerÂÜÖÂÆπÂ∑≤‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ìÔºåID:', this.taskManagerId, '‰ªªÂä°ÂêçÁß∞:', realTaskName);
        } else {
          console.error('‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ìÂ§±Ë¥•:', response.status);
        }
      } catch (error) {
        console.error('Êï∞ÊçÆÂ∫ì‰øùÂ≠òÊìç‰ΩúÂ§±Ë¥•:', error);
      }
    },
    
    /**
     * Êõ¥Êñ∞Êï∞ÊçÆÂ∫ì
     */
  async updateDatabase() {
      if (!this.taskManagerId) {
        // Â¶ÇÊûúÊ≤°ÊúâIDÔºåÂàôÂàõÂª∫Êñ∞ËÆ∞ÂΩï
        await this.saveToDatabase();
        return;
      }
      
      try {
        // Ëé∑ÂèñÂΩìÂâçÁúüÊ≠£ÁöÑ‰ªªÂä°ÂêçÁß∞
        const realTaskName = this.getCurrentTaskName();
        
        console.log('TaskManagerÊõ¥Êñ∞Êï∞ÊçÆÂ∫ì - ‰ªªÂä°ÂêçÁß∞:', realTaskName);
        
        const response = await fetch(`/api/update-task-manager/${this.taskManagerId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            addedTasks: this.addedTasks,
            taskDetails: this.taskDetails,
            taskName: realTaskName
          })
        });

        if (response.ok) {
          this.currentTaskName = realTaskName; // Êõ¥Êñ∞ÂΩìÂâç‰ªªÂä°ÂêçÁß∞
          console.log('TaskManagerÂÜÖÂÆπÂ∑≤Êõ¥Êñ∞Âà∞Êï∞ÊçÆÂ∫ìÔºå‰ªªÂä°ÂêçÁß∞:', realTaskName);
        } else {
          console.error('Êõ¥Êñ∞Êï∞ÊçÆÂ∫ìÂ§±Ë¥•:', response.status);
        }
      } catch (error) {
        console.error('Êï∞ÊçÆÂ∫ìÊõ¥Êñ∞Êìç‰ΩúÂ§±Ë¥•:', error);
      }
    },
    
    /**
     * Âä†ËΩΩÁâπÂÆö‰ªªÂä°ÁöÑÊï∞ÊçÆÔºàAIÂõûÂ§ç„ÄÅ‰ªªÂä°ËØ¶ÊÉÖÁ≠âÔºâ
     */
    async loadTaskData(taskName) {
      try {
        console.log(`Âä†ËΩΩ‰ªªÂä°Êï∞ÊçÆ: ${taskName}`);
        
        const response = await fetch(`/api/task-manager-content/${encodeURIComponent(taskName)}`);
        if (response.ok) {
          const data = await response.json();
          if (data.success && data.taskManagerContents && data.taskManagerContents.length > 0) {
            // ÂèñÊúÄÊñ∞ÁöÑËÆ∞ÂΩïÔºàÊåâÂàõÂª∫Êó∂Èó¥ÈôçÂ∫èÊéíÂàóÔºâ
            const tm = data.taskManagerContents[0];
            
            // ÊÅ¢Â§çÂ∑≤Ê∑ªÂä†ÁöÑ‰ªªÂä°
            if (tm.added_tasks) {
              this.addedTasks = tm.added_tasks;
            }
            
            // ÊÅ¢Â§ç‰ªªÂä°ËØ¶ÊÉÖ
            if (tm.task_details) {
              this.taskDetails = tm.task_details;
            }
            
            // ‰øùÂ≠òÊï∞ÊçÆÂ∫ìËÆ∞ÂΩïID
            this.taskManagerId = tm.id;
            
            console.log(`ÊàêÂäüÂä†ËΩΩ‰ªªÂä° ${taskName} ÁöÑÊï∞ÊçÆ`);
          } else {
            console.log(`Êï∞ÊçÆÂ∫ì‰∏≠Ê≤°ÊúâÊâæÂà∞‰ªªÂä° ${taskName} ÁöÑËÆ∞ÂΩï`);
          }
        } else {
          console.log(`‰ªéÊï∞ÊçÆÂ∫ìÂä†ËΩΩ‰ªªÂä° ${taskName} Â§±Ë¥•:`, response.status);
        }
      } catch (error) {
        console.error(`Âä†ËΩΩ‰ªªÂä° ${taskName} Êï∞ÊçÆÂ§±Ë¥•:`, error);
      }
    },
    
    /**
     * ‰ªéÊï∞ÊçÆÂ∫ìÂä†ËΩΩTaskManagerÁä∂ÊÄÅÔºàÂ∑≤Â∫üÂºÉÔºå‰ΩøÁî® loadTaskData Êõø‰ª£Ôºâ
     */
    async loadFromDatabase() {
      // Ëé∑ÂèñÂΩìÂâç‰ªªÂä°ÂêçÁß∞
      const taskName = this.getCurrentTaskName();
      this.currentTaskName = taskName;
      
      if (!taskName) {
        console.log('Ê≤°ÊúâÂΩìÂâç‰ªªÂä°ÂêçÁß∞ÔºåË∑≥ËøáÊï∞ÊçÆÂ∫ìÂä†ËΩΩ');
        return;
      }
      
      // ‰ΩøÁî®Êñ∞ÁöÑloadTaskDataÊñπÊ≥ï
      await this.loadTaskData(taskName);
    }
  },
  watch: {
    activePlanTaskId() {
      this.editablePlanContent = this.currentPlanContent;
    }
  }
};
</script>

<style scoped>
:root {
  /* È¢úËâ≤ÂèòÈáè */
  --primary-color: #3b3b6d;
  --secondary-color: #5a5a89;
  --accent-color: #007bff;
  --background-gradient: linear-gradient(135deg, #e0e7ff 0%, #f9f9f9 100%);
  --sidebar-gradient: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
  --success-gradient: linear-gradient(90deg, #28a745 0%, #5be584 100%);
  --warning-gradient: linear-gradient(90deg, #ffc107 0%, #ffe082 100%);
  
  /* ËæπË∑ùÂíåÂ∞∫ÂØ∏ÂèòÈáè */
  --border-radius: 6px;
  --border-radius-large: 14px;
  --border-radius-xlarge: 18px;
  --shadow-light: 0 2px 12px rgba(60, 60, 120, 0.06);
  --shadow-medium: 0 4px 20px rgba(60, 60, 120, 0.15);
  --shadow-heavy: 0 6px 32px rgba(60, 60, 120, 0.10);
  
  /* ËøáÊ∏°ÂèòÈáè */
  --transition-fast: 0.2s;
  --transition-medium: 0.3s;
}

.template-wrapper {
  display: flex;
  min-height: 100vh;
  background: var(--background-gradient);
  font-family: 'Segoe UI', 'Arial', sans-serif;
}

/* ‰∏ªË¶ÅÂÜÖÂÆπÂå∫ÂüüÂ∏ÉÂ±Ä */
.main-content {
  display: flex;
  flex: 1;
  min-height: 0;
}

/* Â∑¶‰æßËæπÊ†èÊ†∑Âºè - ‰∏éTemplate.vue‰øùÊåÅ‰∏ÄËá¥ */
.sidebar {
  width: 250px;
  background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
  color: white;
  padding: 20px;
  box-shadow: 2px 0 8px rgba(0, 0, 0, 0.2);
  display: flex;
  flex-direction: column;
  position: relative;
  transition: width var(--transition-medium) ease;
}

.sidebar.collapsed {
  width: 48px;
  padding: 24px 4px;
}

.task-list {
  flex: 0 0 auto;
}

.toggle-icon {
  position: absolute;
  top: 16px;
  left: 12px;
  cursor: pointer;
  font-size: 1.6em;
  color: #3498db;
  transition: color var(--transition-medium) ease;
  z-index: 10;
}

.toggle-icon:hover {
  color: #e74c3c;
}

.task-list h2 {
  margin: 24px 0 20px 0;
  font-size: 1.3em;
  text-align: center;
  color: #ecf0f1;
  border-bottom: 2px solid rgba(255, 255, 255, 0.3);
  padding-bottom: 12px;
  font-weight: 600;
  letter-spacing: 1px;
}

.task-counter {
  background: rgba(255, 255, 255, 0.15);
  padding: 18px;
  border-radius: 10px;
  margin-bottom: 20px;
  text-align: center;
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.task-counter p {
  margin: 0;
  font-size: 1.1em;
  color: #ecf0f1;
  font-weight: 500;
}

.count {
  font-weight: bold;
  font-size: 1.4em;
  color: #f39c12;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
}

.task-history {
  list-style: none;
  padding: 0;
  margin: 0;
  flex: 1;
  overflow-y: auto;
  max-height: 300px;
}

.task-item {
  padding: 12px;
  margin-bottom: 10px;
  background: rgba(255, 255, 255, 0.15);
  border-radius: 8px;
  border-left: 4px solid #3498db;
  transition: all var(--transition-fast);
  border: 1px solid rgba(255, 255, 255, 0.1);
  cursor: pointer;
  display: flex;
  flex-direction: column;
  align-items: stretch;
}

.task-item:hover {
  background: rgba(255, 255, 255, 0.25);
  border-left-color: #2980b9;
  transform: translateX(2px);
}

.task-item.active {
  background: rgba(52, 152, 219, 0.3);
  border-left-color: #2980b9;
  color: #fff;
  font-weight: 700;
}

.task-item .delete-icon {
  color: #e74c3c;
  cursor: pointer;
  font-size: 1.1em;
  transition: color 0.2s;
  padding: 4px;
  border-radius: 3px;
  opacity: 0.7;
}

.task-item .delete-icon:hover {
  color: #c0392b;
  background: rgba(255, 255, 255, 0.2);
  opacity: 1;
}

.task-name {
  font-size: 0.95em;
  display: block;
  word-wrap: break-word;
  line-height: 1.4;
  color: #ecf0f1;
  font-weight: 500;
}

/* ‰∏ÄÁ∫ßÊ†áÈ¢òÊ†∑ÂºèÔºàÁà∂‰ªªÂä°Ë°åÔºâ */
.parent-row {
  display: flex;
  align-items: center;
  gap: 8px;
  width: 100%;
}
.task-name.h1 {
  font-size: 1.05em;
  font-weight: 700;
}
.expand-icon {
  color: #f39c12;
}

/* ‰∫åÁ∫ßÊ†áÈ¢òÊ†∑ÂºèÔºàÂ≠ê‰ªªÂä°ÊåâÈíÆÔºâ */
.dynamic-task-button.h2 {
  font-size: 0.92em;
  padding-left: 16px;
}
.subtasks-list {
  width: 100%;
  margin-top: 10px;
}

.dynamic-tasks {
  margin-top: 15px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.sub-task-header {
  font-size: 0.9em;
  color: #bdc3c7;
  margin-bottom: 8px;
  padding: 8px 12px;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 4px;
  text-align: center;
  font-weight: 600;
}

.dynamic-task-button {
  width: 100%;
  padding: 10px 12px;
  background: rgba(255, 255, 255, 0.15);
  color: #ecf0f1;
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 6px;
  font-size: 0.95em;
  font-weight: 600;
  cursor: pointer;
  transition: all var(--transition-fast);
  border-left: 4px solid #3498db;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.dynamic-task-button:hover {
  background: rgba(255, 255, 255, 0.25);
  border-left-color: #2980b9;
  transform: translateX(2px);
}

.dynamic-task-button.active {
  background: rgba(52, 152, 219, 0.3);
  border-left-color: #2980b9;
  color: #fff;
  font-weight: 700;
}

.dynamic-task-button .task-text {
  flex: 1;
  text-align: left;
}

.dynamic-task-button .delete-icon {
  color: #e74c3c;
  cursor: pointer;
  font-size: 1.0em;
  transition: color 0.2s;
  padding: 2px 4px;
  border-radius: 3px;
  opacity: 0.7;
}

.dynamic-task-button .delete-icon:hover {
  color: #c0392b;
  background: rgba(255, 255, 255, 0.2);
  opacity: 1;
}

.task-details {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.task-details button {
  width: 100%;
  padding: 12px;
  background: rgba(255, 255, 255, 0.15);
  color: #ecf0f1;
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 8px;
  font-size: 1.08em;
  font-weight: 600;
  cursor: pointer;
  transition: all var(--transition-fast);
  border-left: 4px solid #3498db;
}

.task-details button:hover {
  background: rgba(255, 255, 255, 0.25);
  border-left-color: #2980b9;
  transform: translateX(2px);
}

.task-details button.active {
  background: rgba(231, 76, 60, 0.3);
  border-left-color: #e74c3c;
  color: #fff;
  font-weight: 700;
}

.left-bottom-add {
  margin-top: auto;
  padding-top: 16px;
}

.left-bottom-add button {
  width: 100%;
  background: var(--success-gradient);
  color: #fff;
  border: none;
  border-radius: var(--border-radius);
  padding: 12px 0;
  font-size: 1.08em;
  font-weight: 700;
  cursor: pointer;
  transition: background var(--transition-medium), transform var(--transition-fast);
  box-shadow: var(--shadow-light);
}

.left-bottom-add button:hover {
  background: linear-gradient(90deg, #218838 0%, #43d477 100%);
  transform: scale(1.04);
}

/* ‰∏ªÂÜÖÂÆπÂÆπÂô® - ‰∏éTemplate.vue‰øùÊåÅ‰∏ÄËá¥ */
.template-container {
  flex: 1;
  padding: 40px;
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  align-items: center;
  background: transparent;
  overflow-y: auto;
  min-height: 0;
  position: relative;
}

/* AIÂõûÂ§çÊùøÂùóÊ†∑Âºè */
.ai-response {
  width: 90%;
  max-width: 820px;
  margin-bottom: 28px;
  padding: 32px 28px 24px 28px;
  border: 1.5px solid #d1d5db;
  border-radius: var(--border-radius-large);
  background: #fff;
  cursor: default;
  box-shadow: var(--shadow-light);
  transition: box-shadow var(--transition-medium), background var(--transition-medium);
  flex-shrink: 0;
}

.ai-response:hover {
  box-shadow: var(--shadow-medium);
  background: #f0f4ff;
}

.ai-response h2 {
  margin: 0 0 18px 0;
  font-size: 1.22em;
  color: var(--primary-color);
  font-weight: 700;
  text-align: center;
  letter-spacing: 1px;
}

.ai-content {
  max-height: none !important;
  overflow: visible !important;
  height: auto !important;
}

.ai-text {
  white-space: normal;
  word-wrap: break-word;
  line-height: 1.6;
  font-size: 1.05em;
  color: #444;
  max-height: none;
  overflow: visible;
}

/* Markdown ÂÜÖÂÆπÊ†∑Âºè */
.ai-text :deep(p) {
  margin: 8px 0;
  white-space: normal;
  word-wrap: break-word;
}

.ai-text :deep(pre) {
  white-space: pre-wrap;
  word-wrap: break-word;
  background-color: #f5f5f5;
  padding: 12px;
  border-radius: var(--border-radius);
  overflow-x: auto;
}

.ai-text :deep(ul),
.ai-text :deep(ol) {
  margin: 8px 0;
  padding-left: 20px;
}

.ai-text :deep(li) {
  margin: 4px 0;
}

.ai-text :deep(h1),
.ai-text :deep(h2),
.ai-text :deep(h3),
.ai-text :deep(h4),
.ai-text :deep(h5),
.ai-text :deep(h6) {
  margin: 16px 0 8px 0;
  color: var(--primary-color);
}

.ai-text :deep(strong) {
  font-weight: bold;
  color: var(--primary-color);
}

.ai-text :deep(em) {
  font-style: italic;
}

.ai-text :deep(code) {
  background-color: #f5f5f5;
  padding: 2px 4px;
  border-radius: 3px;
  font-family: 'Courier New', monospace;
  font-size: 0.9em;
}

.ai-text :deep(blockquote) {
  border-left: 4px solid var(--accent-color);
  padding-left: 12px;
  margin: 16px 0;
  color: #666;
}

.ai-text :deep(table) {
  width: 100%;
  border-collapse: collapse;
  margin: 16px 0;
}

.ai-text :deep(th),
.ai-text :deep(td) {
  border: 1px solid #ddd;
  padding: 8px;
  text-align: left;
}

.ai-text :deep(th) {
  background-color: #f5f5f5;
  font-weight: bold;
}

/* ‰ªªÂä°ÊùøÂùóÊ†∑Âºè */
.tasks {
  width: 90%;
  max-width: 820px;
  margin-bottom: 24px;
  padding: 32px 28px 24px 28px;
  border: 1.5px solid #d1d5db;
  border-radius: var(--border-radius-large);
  background: #fff;
  transition: background-color var(--transition-medium), box-shadow var(--transition-medium);
  box-shadow: var(--shadow-light);
  cursor: default;
}

.tasks:hover {
  background-color: #e0ffe0;
  box-shadow: var(--shadow-medium);
}

.tasks h2 {
  color: var(--primary-color);
  margin: 0 0 18px 0;
  font-size: 1.22em;
  font-weight: 700;
  text-align: center;
  letter-spacing: 1px;
}

.tasks ul {
  list-style-type: none;
  padding: 0;
  margin: 0;
}

.tasks li {
  margin-bottom: 12px;
  font-size: 1.05em;
  color: #333;
  line-height: 1.6;
}

/* Â∫ïÈÉ®ÊåâÈíÆÊ†∑Âºè - ÊîæÂú®Âè≥‰æßÂ∫ïÈÉ® */
.right-footer {
  width: 90%;
  max-width: 820px;
  padding: 24px 0 0 0;
  background: transparent;
  text-align: center;
  margin-top: auto;
}

.continue-button {
  background: #28a745; /* ÊµÖÁªøËâ≤Â∏∏Èáè */
  color: white;
  padding: 14px 0;
  border: none;
  border-radius: var(--border-radius);
  cursor: pointer;
  width: 100%;
  font-size: 1.22em;
  font-weight: 700;
  transition: background var(--transition-medium), transform var(--transition-fast);
  box-shadow: var(--shadow-light);
}

.continue-button:hover {
  background: #1e7e34; /* Ê∑±ÁªøËâ≤ */
  transform: scale(1.03);
}

/* ÊªöÂä®Êù°Ê†∑Âºè */
::-webkit-scrollbar {
  width: 8px;
  background: #e0e7ff;
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: #bfcfff;
  border-radius: 4px;
}

/* ÂìçÂ∫îÂºèËÆæËÆ° */
@media (max-width: 768px) {
  .template-wrapper {
    flex-direction: column;
  }
  
  .sidebar {
    width: 100%;
    padding: 15px;
    order: -1;
  }
  
  .template-container {
    padding: 20px;
  }
  
  .ai-response,
  .tasks {
    width: 100%;
    padding: 20px;
  }
  
  .right-footer {
    width: 100%;
    padding: 20px 0 0 0;
  }
}

/* ÂÖºÂÆπÊäòÂè†Áä∂ÊÄÅÁöÑÊ†∑Âºè */
.sidebar.collapsed .task-list h2,
.sidebar.collapsed .task-counter,
.sidebar.collapsed .task-history,
.sidebar.collapsed .dynamic-tasks,
.sidebar.collapsed .task-details,
.sidebar.collapsed .left-bottom-add button {
  display: none;
}

.sidebar.collapsed .toggle-icon {
  left: 16px;
}
</style>